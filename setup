#!/bin/sh

export DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export STATUS_REPO='https://github.com/powerline/fonts.git'
export VUNDLE_REPO='https://github.com/VundleVim/Vundle.vim.git'
export VUNDLE_PATH="${DIR}/.vim/bundle/Vundle.vim"

PROJECTS_DIR="${HOME}/Dropbox/.projects"

function run() {
    name=${1}
    echo "--> \`${name}\`"
    eval "${name}"
}

function input() {
    name=${1}
    question="${2}"
    if [ -z "$(eval ${name})" ]; then
        echo "${question}"
        read -r value
        run "${name} \"${value}\""
    fi
}

function delete_if_not_symlink_dir() {
    test -d "${1}" -a ! -L "${1}" && rm -rfi "${1}"
}

function link_dotfiles() {
    base="${1}"
    ln -fs "${base}/.vim"
    ln -fs "${base}/.vimrc"
    ln -fs "${base}/.gitignore_global"
    ln -fs "${base}/.aliases"
    ln -fs "${base}/.zshrc"
    ln -fs "${base}/.bashrc"
    ln -fs "${base}/.bash_login"
    ln -fs "${base}/.babushka"
    ln -fs "${base}/.tmux.conf"
}

# TODO(maros): Convert everything in this setup script to Babuska deps.
brew update
sh -c "`curl --silent https://babushka.me/up/v0.19.0`" </dev/null
babushka dotfiles

cd "${HOME}"

delete_if_not_symlink_dir .vim
delete_if_not_symlink_dir .babushka

# Install projects.
if [ -d "${PROJECTS_DIR}" ]; then
    rsync -avh --delete "${PROJECTS_DIR}/" ~/projects
    (crontab -l ; echo "*/10 * * * * ${DIR}/sync") | sort - | uniq - | crontab -
    link_dotfiles ~/projects/dotfiles
else
    echo "${PROJECTS_DIR} is missing. Skipping projects install."
    link_dotfiles "${DIR}"
fi

# Setup global Git ignore config.
git config --global core.excludesfile "${HOME}/.gitignore_global"
git config --global core.editor vim
git config --global push.default simple

input "git config --global user.name"  "Git: Enter first and last name:"
input "git config --global user.email" "Git: Enter email:"

# Setup Vundle package manager.
test ! -e ${VUNDLE_PATH} && git clone "${VUNDLE_REPO}" "${VUNDLE_PATH}"
vim +PluginInstall +qall

# Setup status line fonts for Vim.
fonts="$(basename $STATUS_REPO)"
fonts="${DIR}/${fonts%.*}"
test ! -e "${fonts}" && git clone "${STATUS_REPO}" "${fonts}" \
                     && "${fonts}/install.sh"

if [ "$(uname)" == 'Darwin' ]; then
    "${DIR}/setup-mac"
fi

if [ "$(which zsh)" ]; then
    run "chsh -s $(which zsh)"
fi
